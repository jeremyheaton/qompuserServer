<!doctype html>
<html>
	<head>
		<title>Example of the Authorization Code flow with Spotify</title>
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
		<style type="text/css">
			#login, #loggedin {
				display: none;
			}
			.text-overflow {
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				width: 500px;
			}
		</style>
	</head>

	<body>
		<div class="container">
			<div id="login">
				<h1>This is an example of the Authorization Code flow</h1>
				<a href="/login" class="btn btn-primary">Log in with Spotify</a>
			</div>
			<div id="loggedin">
				<div id="user-profile">

				</div>
				<div id="user-playlist"></div>
				<div id="oauth"></div>
				<button class="btn btn-default" id="obtain-new-token">
					Obtain new token using the refresh token
				</button>
				<button class="btn btn-default" id="get-play-lists">
					Obtain playlists
				</button>
				<button class="btn btn-default" id="add-to-lists">
					add to playlist
				</button>

			</div>
		</div>
		<h1>Search for an Artist</h1>
		<p>
			Type an artist name and click on "Search". Then, click on any album from the results to play 30 seconds of its first track.
		</p>
		<form id="search-form">
			<input type="text" id="query" value="" class="form-control" placeholder="Type an Artist Name"/>
			<input type="submit" id="search" class="btn btn-primary" value="Search" />
		</form>
		<div id="results"></div>

		<script id="results-template" type="text/x-handlebars-template">
			{{#each this.tracks.items}}
			<div id={{id}} class="song">{{name}} :  {{artists.0.name}}</div>
			{{/each}}
		</script>
		<script id="playlist-template" type="text/x-handlebars-template">
			{{#each this}}
			<div class="row">

			<p class="playlistnames" id={{playlistid}}>names: {{playlistname}}</p>

			</div>
			{{/each}}
		</script>

		<script id="user-profile-template" type="text/x-handlebars-template">
			<h1>Logged in as {{display_name}}</h1>
			<div class="media">
			<div class="pull-left">
			<img class="media-object" width="150" src="{{images.0.url}}" />
			</div>
			<div class="media-body">
			<dl class="dl-horizontal">
			<dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
			<dt>Id</dt><dd>{{id}}</dd>
			<dt>Email</dt><dd>{{email}}</dd>
			<dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
			<dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
			<dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
			<dt>Country</dt><dd>{{country}}</dd>
			</dl>
			</div>
			</div>
		</script>

		<script id="oauth-template" type="text/x-handlebars-template">
			<h2>oAuth info</h2>
			<dl class="dl-horizontal">
			<dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
			<dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}></dd>
			</dl>
		</script>

		<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
		<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
		<script>
			(function() {

				/**
				 * Obtains parameters from the hash of the URL
				 * @return Object
				 */
				function getHashParams() {
					var hashParams = {};
					var e, r = /([^&;=]+)=?([^&;]*)/g, q = window.location.hash.substring(1);
					while ( e = r.exec(q)) {
						hashParams[e[1]] = decodeURIComponent(e[2]);
					}
					return hashParams;
				}

				var selectedplaylistid;
				var selectedplaylistname;
				var selectedsong;
				var templateSource = document.getElementById('results-template').innerHTML, trackstemplate = Handlebars.compile(templateSource), resultsPlaceholder = document.getElementById('results');

				var playlistSource = document.getElementById('playlist-template').innerHTML, playlistTemplate = Handlebars.compile(playlistSource), playlistPlaceholder = document.getElementById('user-playlist');
				var userProfileSource = document.getElementById('user-profile-template').innerHTML, userProfileTemplate = Handlebars.compile(userProfileSource), userProfilePlaceholder = document.getElementById('user-profile');

				var oauthSource = document.getElementById('oauth-template').innerHTML, oauthTemplate = Handlebars.compile(oauthSource), oauthPlaceholder = document.getElementById('oauth');

				var params = getHashParams();

				var access_token = params.access_token, refresh_token = params.refresh_token, error = params.error;
				var userid
				if (error) {
					alert('There was an error during the authentication');
				} else {
					if (access_token) {
						// render oauth info
						oauthPlaceholder.innerHTML = oauthTemplate({
							access_token : access_token,
							refresh_token : refresh_token
						});

						$.ajax({
							url : 'https://api.spotify.com/v1/me',
							headers : {
								'Authorization' : 'Bearer ' + access_token
							},
							success : function(response) {
								console.log(response);
								userid = response.id;
								userProfilePlaceholder.innerHTML = userProfileTemplate(response);
								$('#login').hide();
								$('#loggedin').show();
							}
						});
					} else {
						// render initial screen
						$('#login').show();
						$('#loggedin').hide();
					}

					// var fetchTracks = function(albumId, callback) {
					// $.ajax({
					// url : 'https://api.spotify.com/v1/albums/' + albumId,
					// success : function(response) {
					// callback(response);
					// }
					// });
					// };

					var searchAlbums = function(query) {
						$.ajax({
							url : 'https://api.spotify.com/v1/search',
							data : {
								q : query,
								type : 'track'
							},
							success : function(response) {
								console.log(response);
								resultsPlaceholder.innerHTML = trackstemplate(response);
								songlistener();

							}
						});
					};

					results.addEventListener('click', function(e) {
						var target = e.target;
						if (target !== null && target.classList.contains('cover')) {
							if (target.classList.contains(playingCssClass)) {
								audioObject.pause();
							} else {
								if (audioObject) {
									audioObject.pause();
								}
								fetchTracks(target.getAttribute('data-album-id'), function(data) {
									audioObject = new Audio(data.tracks.items[0].preview_url);
									audioObject.play();
									target.classList.add(playingCssClass);
									audioObject.addEventListener('ended', function() {
										target.classList.remove(playingCssClass);
									});
									audioObject.addEventListener('pause', function() {
										target.classList.remove(playingCssClass);
									});
								});
							}
						}
					});

					document.getElementById('search-form').addEventListener('submit', function(e) {
						e.preventDefault();
						searchAlbums(document.getElementById('query').value);
					}, false);

					document.getElementById('add-to-lists').addEventListener('click', function() {
						$.ajax({
							method : "POST",
							url : '/addtoplaylist?selectedplaylistid=' + selectedplaylistid + '&userid=' + userid + '&accesstoken=' + access_token + '&song=' + selectedsong,
							success : function(response) {
								console.log(response);

							}
						});
					});
					function playlistlistener() {
						var classname = document.getElementsByClassName("playlistnames");
						for (var i = 0; i < classname.length; i++) {
							classname[i].addEventListener('click', function() {
								selectedplaylistid = this.getAttribute("id");
								selectedplaylistname = this.val;
								console.log(selectedplaylistid);
							});
						};
					};

					function songlistener() {
						var classname = document.getElementsByClassName("song");
						for (var i = 0; i < classname.length; i++) {
							classname[i].addEventListener('click', function() {
								selectedsong = this.getAttribute("id");
								console.log(selectedsong);
							});
						};
					};

					document.getElementById('get-play-lists').addEventListener('click', function() {
						$.ajax({
							url : '/getplaylists?userid=' + userid + '&accesstoken=' + access_token,
							success : function(response) {
								console.log(response);
								playlistPlaceholder.innerHTML = playlistTemplate(response);
								playlistlistener();
							}
						});
					});
					document.getElementById('obtain-new-token').addEventListener('click', function() {
						$.ajax({

							url : '/refresh_token',
							data : {
								'refresh_token' : refresh_token
							}
						}).done(function(data) {
							access_token = data.access_token;
							oauthPlaceholder.innerHTML = oauthTemplate({
								access_token : access_token,
								refresh_token : refresh_token
							});
						});
					}, false);
				}
			})();
		</script>
</html>


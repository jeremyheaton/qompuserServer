<!doctype html>
<html>

	<head>

		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
		<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
		<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
		<script src="https://apis.google.com/js/client.js?onload=googleApiClientReady"></script>
	</head>

	<body>
		<h1>Search for a song by artist, album, or name</h1>
		<p>
			Type an artist name and click on "Search". Then, click on any album from the results to play 30 seconds of its first track.
		</p>
		<form id="search-form">
			<input type="text" id="query" value="" class="form-control" placeholder="Type an Artist Name"/>
			<input type="submit" id="search" class="btn btn-primary" value="Search" />
		</form>
		<div id="results"></div>
		
		<div id="playlist"></div>
		
		<script id="results-template" type="text/x-handlebars-template">
			{{#each this.tracks.items}}
			<div id={{id}} >{{name}} :  {{artists.0.name}}
			<button class="btn btn-default song" source="spotify" songid={{id}} songname="{{name}}" songartist="{{artists.0.name}}" id="add-to-lists">			add to playlist
			</button>
			</div>
			{{/each}}
		</script>
		<script id="playlist-template" type="text/x-handlebars-template">
			{{#each this.songs}}
			<div class="row">
			<div id={{id}} >{{artistname}} :  {{songname.0.name}}
			<p class="playlistnames" id={{playlistid}}>names: {{playlistname}}</p>

			</div>
			{{/each}}
		</script>

		<script>
			(function() {

				/**
				 * Obtains parameters from the hash of the URL
				 * @return Object
				 */

				var selectedplaylistid;
				var selectedplaylistname;
				var selectedsong;
				var templateSource = document.getElementById('results-template').innerHTML, trackstemplate = Handlebars.compile(templateSource), resultsPlaceholder = document.getElementById('results');

				var playlistSource = document.getElementById('playlist-template').innerHTML, playlistTemplate = Handlebars.compile(playlistSource), playlistPlaceholder = document.getElementById('playlist');

			
				

				

				var userid

				var searchAlbums = function(query) {
					$.ajax({
						url : 'https://api.spotify.com/v1/search',
						data : {
							q : query,
							type : 'track'
						},
						success : function(response) {
							console.log(response);
							resultsPlaceholder.innerHTML = trackstemplate(response);
							songlistener();

						}
					});
				};
			
				document.getElementById('search-form').addEventListener('submit', function(e) {
					e.preventDefault();
					searchAlbums(document.getElementById('query').value);
				}, false);

			

				function songlistener() {
					var classname = document.getElementsByClassName("song");
					for (var i = 0; i < classname.length; i++) {
						classname[i].addEventListener('click', function() {
							$.ajax({
								method : "POST",
								url : '/host/' + window.location.href.replace(/.*\//, '') + '?songid=' + this.getAttribute('songid') + '&song=' + this.getAttribute('songname') + '&artist=' + this.getAttribute('songartist'),
								success : function(response) {
									console.log(response);

								}
							});
						});
					};
				};
			}
			)();
		</script>
		<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
		<script>
			var socket = io();

			socket.on('connect', function() {
				socket.emit('subscribe', window.location.href.replace(/.*\//, ''));
				console.log("subscribed to " + window.location.href.replace(/.*\//, '') );
			});
			socket.on('playlist', function(data){
				playlistPlaceholder.innerHTML = playlistTemplate(data);
				console.log(data)
			})
			
		</script>
</html>


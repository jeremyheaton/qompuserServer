<!doctype html>
<html>
	<head>
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
		<link rel="stylesheet" href="../css/styles.css">
		<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
		<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
		<script src="https://apis.google.com/js/client.js?onload=googleApiClientReady"></script>
	</head>

	<body>
		<h1>Search for a song by artist, album, or name</h1>
		<p>
			Type an artist name and click on "Search". Then, click on any album from the results to play 30 seconds of its first track.
		</p>
			<div id="searchcontainer">
                <span style="font-size:30px;cursor:pointer" id="closeSearch">&times;</span>
				<form id="search-form">
					<input type="text" id="query" value="" class="form-control" placeholder="Type an Artist Name"/>
					<input type="submit" id="search" class="btn btn-primary" value="Search" />
				</form>
				<div id="results"></div>
			</div>
        <span style="font-size:30px;cursor:pointer" id="openSearch">&#9776; Search</span>
        <div id="playlist"></div>
		<script id="results-template" type="text/x-handlebars-template">
			{{#each this.tracks.items}}
            <button class="btn btn-primary song" source="spotify" songid={{id}} songname="{{name}}" songartist="{{artists.0.name}}" id="add-to-lists">
                <div id={{id}} >{{name}} By {{artists.0.name}}
            </button>


			</div>
			{{/each}}
		</script>
		<script id="playlist-template" type="text/x-handlebars-template">

			{{#each this.songs}}
			<div class="row">
			<div id={{id}} >{{artistname}} : {{songname}}
			<span class="label label-default">{{count}}</span>
			</button>
			</div>
			</div>
			{{/each}}

		</script>
		<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>

		<script>
			(function() {

                document.getElementById("openSearch").addEventListener("click", function(){
                document.getElementById("searchcontainer").style.width = "100%";
                });
                document.getElementById("closeSearch").addEventListener("click", function(){
                document.getElementById("searchcontainer").style.width = "0px";
                });
				var cookie = getCookie("votedsongs");
				var authCode;
				if(cookie == ""){
					document.cookie = "votedsongs=[]";
					cookie = getCookie("votedsongs");
				}
				var voted = JSON.parse(cookie);

				var playlist;
				//var socket = io("localhost:8888");
				var socket = io("https://ancient-tor-6266.herokuapp.com/");

				socket.on('connect', function() {
				    console.log("connected");
					socket.emit('subscribe', window.location.href.replace(/.*\//, ''));
				});

				socket.on('token', function(data) {
				authCode = data;
				});

				socket.on('playlist', function(data) {
					playlistPlaceholder.innerHTML = playlistTemplate(data);
					playlist = data.songs;
					cookieFixer();
					playlistlistener();

				});

				/**
				 * Obtains parameters from the hash of the URL
				 * @return Object
				 */
				function cookieFixer() {
					var songids = [];
					for (var i = 0; i < playlist.length; i++) {
						songids.push(playlist[i].id);
					}
					for (var j = 0; j < voted.length; j++) {
						if (songids.indexOf(voted[j]) >= 0) {

						} else {
							voted.splice(j, 1);
						}
					}
					document.cookie = "votedsongs=" + JSON.stringify(voted);
				}

				var selectedplaylistid;
				var selectedplaylistname;
				var selectedsong;
				var templateSource = document.getElementById('results-template').innerHTML, trackstemplate = Handlebars.compile(templateSource), resultsPlaceholder = document.getElementById('results');

				var playlistSource = document.getElementById('playlist-template').innerHTML, playlistTemplate = Handlebars.compile(playlistSource), playlistPlaceholder = document.getElementById('playlist');

				var userid

				var searchAlbums = function(query) {
					$.ajax({
						url : 'https://api.spotify.com/v1/search',
						headers : {'Authorization' : 'Bearer ' + authCode} ,
						data : {
							q : query,
							type : 'track'
						},
						success : function(response) {
							console.log(response);
							resultsPlaceholder.innerHTML = trackstemplate(response);
							songlistener();

						}
					});
				};

				document.getElementById('search-form').addEventListener('submit', function(e) {
					e.preventDefault();
					searchAlbums(document.getElementById('query').value);
				}, false);

				function playlistlistener() {

					$('.vote').click(function() {
						if ($(this).hasClass('voted')) {

							socket.emit('hate', this.getAttribute('songid'));
							$(this).toggleClass('voted');
						} else {
							$(this).toggleClass('voted');
							socket.emit('like', this.getAttribute('songid'));
						}

					});

				};

				function checkplaylist(songid) {
					for (var i = 0; i < playlist.length; i++) {
						if (playlist[i].id == songid) {
							return true;
							break;
						}
					}
				}

				function songlistener() {
					var classname = document.getElementsByClassName("song");
					for (var i = 0; i < classname.length; i++) {
						classname[i].addEventListener('click', function() {
							if (voted.indexOf(this.getAttribute('songid')) >= 0) {
							} else {
								voted.push(this.getAttribute('songid'))
								document.cookie = "votedsongs=" + JSON.stringify(voted);
                                socket.emit('addSong', { room: window.location.href.replace(/.*\//, ''), message: this.getAttribute('songid'),
                                    song: this.getAttribute('songname') , artist: this.getAttribute('songartist')});
							}
						});
					};
				};

				function getCookie(cname) {
					var name = cname + "=";
					var ca = document.cookie.split(';');
					for (var i = 0; i < ca.length; i++) {
						var c = ca[i];
						while (c.charAt(0) == ' ')
						c = c.substring(1);
						if (c.indexOf(name) == 0)
							return c.substring(name.length, c.length);
					}
					return "";
				}

			}
			)();

		</script>
</html>

